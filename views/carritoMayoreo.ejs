<head>
	<%- include('includes/head.ejs') %>
</head>
<body>	
	<% //console.log("arrayNuevito:"+arrayNuevito); %>
	<% //console.log("arrayNuevito:"+Cantidades); %>
	<% //console.log("arrayOriginal:"+arrayProductos); %>
	
	<link rel="stylesheet" type="text/css" href="/css/carritoMayoreo.css">
    <%- include("includes/navbarH2F.ejs") %>

	<script>
	function recargaForzada(){
		var f = document.createElement("FORM");
		f.style.display = "none";
		document.body.appendChild(f);

		f.action = "/H2Flow/CarroMayoreo";
		f.method = "POST";

		var x = document.createElement("INPUT");
		x.setAttribute("type", "text");

		var arrayObjetos = [];
		for(var i=0;i<=sessionStorage.getItem("numObjetosMayoreo");i++){	
			//si tienes problemas con la cantidad de objetos cambia el .lenght por sessionStorage.getItem("numObjetos")
			arrayObjetos.push(sessionStorage.getItem("productoMayoreo" + i));
		}

		x.value = arrayObjetos;
		x.name = "arrayProductos";

		var y = document.createElement("INPUT");
		y.setAttribute("type", "text");
		y.value = sessionStorage.getItem("numObjetosMayoreo"); 
		y.name = "contadorMayoreo";
		f.appendChild(y);
		f.appendChild(x);
		f.submit();
		
	}
	</script>
	
    <main class="">
		
		<div class="ContenidosDelCarrito">
			<article class="left">
				<header class="PresentacionCart">
                    <h1 class="Titulazo"><svg width="2em" height="1em" viewBox="0 0 16 16" class="bi bi-cart-check" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M11.354 5.646a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L8 8.293l2.646-2.647a.5.5 0 0 1 .708 0z"/>
  <path fill-rule="evenodd" d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm7 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
</svg> Prodcutos por cotizar:</h1>
                </header>
				
				<div class="card__content">
					
					<div class="gridMejorado">
						<%var precioTotal = 0 %>
						<%var correoCot = '' %>
						<%if(arrayNuevito != undefined) {%>
						<% for (var i = 0; i < arrayNuevito.length; i++) { %>
							<%if(arrayNuevito[i] != undefined) {%>
							<% precioTotal = precioTotal + arrayNuevito[i].Precio*Cantidades[i] %>
									
						<svg width="2em" class="bi bi-x-square closeButton1 lorem" type="button" onclick="eliminarToda('<%= arrayNuevito[i]._id%>')" height="2em" viewBox="0 0 16 16" class="" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M14 1H2a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
  <path fill-rule="evenodd" d="M11.854 4.146a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708-.708l7-7a.5.5 0 0 1 .708 0z"/>
  <path fill-rule="evenodd" d="M4.146 4.146a.5.5 0 0 0 0 .708l7 7a.5.5 0 0 0 .708-.708l-7-7a.5.5 0 0 0-.708 0z"/>
</svg>
						<!-- <span class="closeButton1 lorem">&#x2717;</span> -->
							<h3 class="titulo"><%='Producto: '+arrayNuevito[i].Botella%> <%=arrayNuevito[i].color%> de <%=arrayNuevito[i].Volumen%> ml</h3>
								<!--<article class="card product-item">-->
									<div class="ProductoInvidualMOstrado">
										<div class="infoBasica">
											<p><img width = "10vw" height = "200vh" class="imagen" src='<%=arrayNuevito[i].LinksImagenes[0] %>'></p>
										    <h5 class="description">
												Descripcion: <%= arrayNuevito[i].Caracteristicas %>
											</h5>
											
									</div>
									<div class="cantidad2">
									<h2 style="font-size:25px;" class="Can">Cantidad:</h2> 
											
											<input type="text" class="cantidadbackground" name="usrname" value="0">	
											<!-- <h2 class="cantidadbackground"><%= //Cantidades[i]%></h2>  -->
		<svg class="sumaYresta" width="1.5em" height="1.5em" viewBox="0 0 16 16" onclick="guardarCarrro('<%= arrayNuevito[i]._id%>')" class="bi bi-plus" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M8 3.5a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5H4a.5.5 0 0 1 0-1h3.5V4a.5.5 0 0 1 .5-.5z"/>
  <path fill-rule="evenodd" d="M7.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H8.5V12a.5.5 0 0 1-1 0V8z"/>
</svg>
										</div>	
									</div>
									<div class="separacion"></div>
								<!--</article>-->
								<%correoCot = correoCot + Cantidades[i] +' '+ arrayNuevito[i].Botella + arrayNuevito[i].color +', '%>
							<% } %>
							<%}%>
						<%}%>
						<span style="display:none;" id="correoCot"><%=correoCot%></span>
						</div>
                </div>
			</article>
			<article class=" product-item checkout" class="tabla">
				<header class="cantidad">
                    <h2 class="total">Cotizar:</h2>
                </header>				
				<div class="card__content Cobro">
					<div class="Cobro">
                    	<h5 class="Subtotal"><svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-x-diamond" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M8.361 1.17a.51.51 0 0 0-.722 0L4.766 4.044 8 7.278l3.234-3.234L8.361 1.17zm3.595 3.596L8.722 8l3.234 3.234 2.873-2.873c.2-.2.2-.523 0-.722l-2.873-2.873zm-.722 7.19L8 8.722l-3.234 3.234 2.873 2.873c.2.2.523.2.722 0l2.873-2.873zm-7.19-.722L7.278 8 4.044 4.766 1.17 7.639a.511.511 0 0 0 0 .722l2.874 2.873zM6.917.45a1.531 1.531 0 0 1 2.166 0l6.469 6.468a1.532 1.532 0 0 1 0 2.166l-6.47 6.469a1.532 1.532 0 0 1-2.165 0L.45 9.082a1.531 1.531 0 0 1 0-2.165L6.917.45z"/>
</svg> <%= contar%> cotizaciones por enviar</h5>
						
                	</div>
					<div class="card__actions Cobro">
						<a onclick="sinCheckout()" class="btn">Pedir cotizacion</a>
					</div> 
                </div>
			</article>
		</div>
	</main>
	
<script>
//var arrayProductos=[];
var arrayProductos= document.getElementsByName("usrname");	
	//alert("<%-Cantidades[0]%>");
	var cantidad=[];
	var ids =[];
	var j=0;
	<% for(var i=0;i<Cantidades.length;i++){ %>
		//alert("alert");
		cantidad[j]="<%=Cantidades[i]%>";
		ids[j]="<%=arrayNuevito[i]._id%>";
		j++;
	<% 		}  %>
					  
	//alert(cantidad[0]);				  
for(var i=0;i<arrayProductos.length;i++){
	
	
	arrayProductos[i].value=cantidad[i];
	agregaListenerBeach(arrayProductos[i],i+1,ids[i]);
	
}

	

	
</script>	
	
<script>
function agregaListenerBeach(objetoPorSerEmbarazado,entero,id){//AQUI TE QUEDASTE, DICE QUE NO ESTA DEFINIDA
	
objetoPorSerEmbarazado.addEventListener('change', (event) => {

	guardarCarrro(objetoPorSerEmbarazado,entero,id);

});
	
	
	
}	

	
</script>	
	
<script>
	function guardarCarrro(ProdcutoporGuardar,entero,id){
		
		 var cantiad = ProdcutoporGuardar;
		var cantidadReal=ProdcutoporGuardar.value //el value esta dentro de producto por guardar
	
		//de esta manera se guarda info del server en el cache
		if(!sessionStorage.getItem("numObjetosMayoreo")){	
			//si no hay nada, creamos el objeto
			sessionStorage.setItem('numObjetosMayoreo',"1");
		}else{
		//Se guarda el numero de cotizaciones hechas
			
// sessionStorage.setItem('numObjetosMayoreo',Number(sessionStorage.getItem("numObjetosMayoreo"))+1);
		
		}
		//se guarda el producto y se le concatena el numero interesado de cotizaciones
	var stringPorGuardar=id + "/" + cantidadReal;
	sessionStorage.setItem('productoMayoreo' + entero, stringPorGuardar);
		// alert(stringPorGuardar);
		// alert(sessionStorage.getItem('productoMayoreo' +    sessionStorage.getItem("numObjetosMayoreo")))
	
	recargaForzada();
		
	}
</script>
	
<script>
	function eliminarToda(item){
		var contador=0;	
		var cuantasMenos=0;
		var band=0;
		var sobrevivientes=[];
		for(var i=0;i<=sessionStorage.getItem("numObjetosMayoreo");i++){	
			string1=String(item);
			string2=String(sessionStorage.getItem('productoMayoreo' + (i)));
			string2 =string2.slice(0, 24);
			alert("El primer string del ciclo"+i+":"+string1);
			alert("El Segundo string del ciclo"+i+":"+string2);
			if(string1===string2){
				 alert("eliminando"+sessionStorage.getItem('productoMayoreo' + i));
				if(cuantasMenos===0){contador=i;}
				sessionStorage.removeItem('productoMayoreo' + i);
				cuantasMenos++;
			}else{  sobrevivientes.push(sessionStorage.getItem('productoMayoreo' + i));         }
		}
		sessionStorage.setItem('numObjetosMayoreo',Number(sessionStorage.getItem("numObjetosMayoreo"))-cuantasMenos);
		for(var i=1;i<=sessionStorage.getItem("numObjetosMayoreo");i++){	
			sessionStorage.setItem('productoMayoreo' + (i), sobrevivientes[i]);
		}
	recargaForzada();
	}

	function sinCheckout(){
		if(sessionStorage.length>1){       //Se puede cambiar el sessionStorage por el contador 
			// self.location("/Checkout");//Falta este pedo en ventana actual
			var cor = document.getElementById('correoCot').innerHTML;
			sessionStorage.setItem('ObjCorMay',cor)
			window.open("/H2Flow/correoCotizacion","MsgWindow", "width=1000vw,height=800vh");
		}else{
			alert("Porfavor agregue algun producto para que podamos cotizar");
		}
	}

	function eliminarClick(item){
		var contador=0;	
		for(var i=1;i<=sessionStorage.getItem("numObjetosMayoreo");i++){	
			string1=String(item);
			string2=String(sessionStorage.getItem('productoMayoreo' + (i)));
			if(string1===string2){
				contador=i;
				sessionStorage.removeItem('productoMayoreo' + i);
				sessionStorage.setItem('numObjetosMayoreo',Number(sessionStorage.getItem("numObjetosMayoreo"))-1);
				break;
			}
		}
		// var victima = "producto" + item;
		// sessionStorage.removeItem(victima);
		for(var i=contador;i<=sessionStorage.getItem("numObjetosMayoreo");i++){
			sessionStorage.setItem('productoMayoreo' + i, sessionStorage.getItem('productoMayoreo' + (i+1)));	
		}
		recargaForzada();
	}
</script>
	
<script> 	
	var NumNuevo = Number(sessionStorage.getItem("numObjetosMayoreo"));
	var NumViejo = Number("<%=contar%>");  
	if( NumViejo < NumNuevo){
		
		recargaForzada();
		
	}
</script>
	
</body>

<%- include("includes/end.ejs") %>
	
	